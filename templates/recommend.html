{% extends 'base.html' %}

{% block title %}
  Recommend Page
{% endblock %}

{% block body %}
<section class="text-center p-5 text-white" style="background: linear-gradient(45deg, #f8a304, #ffbb00);">
  <div class="container">
    <h1 class="display-4 fw-bold">Get Your Personalized Course Recommendations</h1>
    <p class="lead">Answer a few questions and upload your resume to receive AI-powered course recommendations.</p>
  </div>
</section>

<div class="container my-5">

  <!-- ðŸ”· Stepper Phase Bar -->
  <div class="stepper mb-5 d-flex justify-content-between position-relative">
    {% for i in range(1, 6) %}
    <div class="step text-center flex-fill" id="step-{{ i }}">
      <div class="circle">{{ i }}</div>
      <div class="label">
        {% if i == 1 %}Academics{% elif i == 2 %}Work{% elif i == 3 %}Other{% elif i == 4 %}Resume{% else %}Review{% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ðŸ§¾ Multi-Step Form -->
  <form id="multiStepForm" class="needs-validation" novalidate method="POST" enctype="multipart/form-data" action="{{ url_for('recommendation.recommend') }}">

    <!-- STEP 1 -->
    <div class="form-step">
        <div class="mb-3">
          <label class="form-label">Degree</label>
          <select class="form-select" name="degree_names">
            <option value="">Select your degree</option>
            {% for degree in degree_options %}
              <option value="{{ degree }}">{{ degree }}</option>
            {% endfor %}
          </select>
        </div>
      
        <div class="mb-3">
          <label class="form-label">Major 1</label>
          <select class="form-select" name="major1_mapped">
            <option value="">Select your major</option>
            {% for major in major1_options %}
              <option value="{{ major }}">{{ major }}</option>
            {% endfor %}
          </select>
        </div>
      
        <div class="mb-3">
          <label class="form-label">Major 2</label>
          <select class="form-select" name="major2_mapped" >
            <option value="">Select your major</option>
            {% for major in major2_options %}
              <option value="{{ major }}">{{ major }}</option>
            {% endfor %}
          </select>
        </div>
      
        <!-- ðŸ“Œ Inline Row with GPA, Institutions, Graduation Year -->
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">GPA</label>
            <input type="number" step="0.01" min="0" max="4.0" class="form-control" name="gpa" >
          </div>
      
          <div class="col-md-4 mb-3">
            <label class="form-label">Institutions Attended</label>
            <input type="number" class="form-control" name="institution_count" min="0" >
          </div>
      
          <div class="col-md-4 mb-3">
            <label class="form-label">Year of Graduation</label>
            <input type="number" class="form-control" name="max_passing_year" min="1900" max="2100" >
          </div>
        </div>
    </div>
      

    <!-- STEP 2 -->
    <div class="form-step d-none">
      <div class="mb-3">
        <label class="form-label">Years of work experience</label>
        <input type="number" class="form-control" name="experience" min="0" >
      </div>

      {% for job_label, job_list in [('job1', job1_options), ('job2', job2_options), ('job3', job3_options)] %}
      <div class="mb-3">
        <label class="form-label">{{ job_label.replace('job', 'Job ') }}</label>
        <select class="form-select" name="{{ job_label }}">
          <option value="">Select a job title</option>
          {% for job in job_list %}
            <option value="{{ job }}">{{ job }}</option>
          {% endfor %}
        </select>
      </div>
      {% endfor %}

      
    </div>

    <!-- STEP 3 -->
    <div class="form-step d-none">

      <div class="mb-3">
        <label class="form-label">Age</label>
        <input type="number" class="form-control" name="age" min="0" max="120" >
      </div>

      <div class="mb-3">
        <label class="form-label">Extracurricular Activities</label>
        <select class="form-select" name="extra_curricular" >
          <option value="">Select</option>
          <option value="1">Yes</option>
          <option value="0">No</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Certifications</label>
        <select class="form-select" name="certification" >
          <option value="">Select</option>
          <option value="1">Yes</option>
          <option value="0">No</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Foreign Language</label>
        <select class="form-select" name="language">
          <option value="">Select a language</option>
          {% for language in language_options %}
            <option value="{{ language }}">{{ language }}</option>
          {% endfor %}
        </select>
      </div>

    </div>

    <!-- STEP 4 -->
    <div class="form-step d-none">

      <div class="mb-3">
        <label class="form-label">Upload Resume (PDF)</label>
        <input type="file" class="form-control" name="resume" accept="application/pdf">
      </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" >
        <label class="form-check-label">Agree to terms and conditions</label>
      </div>
    </div>

    <!-- STEP 5 -->
    <div class="form-step d-none">
      <h3 class="mb-3">Review Your Information</h3>
      <div id="reviewSection" class="text-white"></div>
    </div>

    <!-- Navigation Buttons -->
    <div class="d-flex justify-content-between mt-4">
      <button type="button" id="prevBtn" class="btn btn-secondary" onclick="nextPrev(-1)">Previous</button>
      <button type="button" id="nextBtn" class="btn btn-primary" onclick="nextPrev(1)">Next</button>
    </div>

  </form>
</div>

<!-- ðŸ–Œï¸ Stepper Styles -->
<style>
.stepper {
  counter-reset: step;
}
.step {
  position: relative;
}
.step .circle {
  width: 40px;
  height: 40px;
  margin: auto;
  border-radius: 50%;
  background: #6c757d;
  color: white;
  line-height: 40px;
  font-weight: bold;
  transition: all 0.3s ease;
}
.step.active .circle {
  background: #0d6efd;
}
.step.completed .circle {
  background: #198754;
}
.step::after {
  content: '';
  position: absolute;
  top: 20px;
  left: 50%;
  height: 4px;
  width: 100%;
  background: #6c757d;
  z-index: -1;
}
.step:first-child::after {
  display: none;
}
.step + .step::after {
  left: -50%;
}
.label {
  margin-top: 8px;
  font-size: 0.875rem;
}
</style>

<!-- ðŸ” Stepper Logic -->
<script>
  const formSteps = document.querySelectorAll('.form-step');
  const stepperSteps = document.querySelectorAll('.step');
  let currentStep = 0;
  const nextBtn = document.getElementById('nextBtn');
  const prevBtn = document.getElementById('prevBtn');

  function showStep(n) {
    formSteps.forEach((step, i) => {
      step.classList.toggle('d-none', i !== n);
      stepperSteps[i].classList.remove('active', 'completed');
      if (i < n) stepperSteps[i].classList.add('completed');
      if (i === n) stepperSteps[i].classList.add('active');
    });

    prevBtn.style.display = n === 0 ? 'none' : 'inline-block';
    nextBtn.innerText = n === formSteps.length - 1 ? 'Submit' : 'Next';

    if (n === formSteps.length - 1) populateReview();
  }

  function nextPrev(n) {
    if (n === 1 && !validateForm()) return;

    if (currentStep === formSteps.length - 1 && n === 1) {
      document.getElementById('multiStepForm').submit();
      return;
    }

    currentStep += n;
    showStep(currentStep);
  }

  function validateForm() {
    const fields = formSteps[currentStep].querySelectorAll('input, select');
    let valid = true;
    fields.forEach(field => {
      if (!field.checkValidity()) {
        field.classList.add('is-invalid');
        valid = false;
      } else {
        field.classList.remove('is-invalid');
      }
    });
    return valid;
  }

  function populateReview() {
    const formData = new FormData(document.getElementById('multiStepForm'));
    let html = '<ul class="list-group">';

    const booleanFields = ['extra_curricular', 'certification'];

    const labelMap = {
        degree_names: 'Degree',
        major1_mapped: 'Major 1',
        major2_mapped: 'Major 2',
        gpa: 'GPA',
        institution_count: 'Institutions Attended',
        max_passing_year: 'Graduation Year',
        experience: 'Years of Work Experience',
        job1: 'Job 1',
        job2: 'Job 2',
        job3: 'Job 3',
        age: 'Age',
        extra_curricular: 'Extracurricular Activities',
        certification: 'Certifications',
        language: 'Foreign Language',
        resume: 'Resume'
    };

    for (let [key, value] of formData.entries()) {
        let displayValue = value;

        // Handle boolean yes/no fields
        if (booleanFields.includes(key)) {
        displayValue = value === '1' ? 'Yes' : value === '0' ? 'No' : '';
        }

        // Handle resume file
        if (key === 'resume') {
        displayValue = value && value.name ? value.name : 'No submission';
        }

        const label = labelMap[key] || key.replaceAll('_', ' ').toUpperCase();

        html += `<li class="list-group-item bg-dark text-light border-secondary">
                <strong>${label}:</strong> ${displayValue}
                </li>`;
    }

    html += '</ul>';
    document.getElementById('reviewSection').innerHTML = html;
  }


  showStep(currentStep);
</script>
{% endblock %}
